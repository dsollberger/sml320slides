{
  "hash": "a99dae245ce76e0e149876bcbe4879d4",
  "result": {
    "markdown": "---\ntitle: \"13: Extending Regression Models\"\nauthor: \"Derek Sollberger\"\ndate: \"2024-03-26\"\nexecute:\n  cache: true\n# format:\n#   revealjs:\n#     scrollable: true\nformat:\n  html:\n    toc: true\n---\n\n\n\\newcommand{\\ds}{\\displaystyle}\n\n# Extending Regression Models\n\n:::: {.columns}\n\n::: {.column width=\"45%\"}\n**Goal:** Explore categorical variables, multivariate models, and interaction terms.\n:::\n\n::: {.column width=\"10%\"}\n\n:::\n\n::: {.column width=\"45%\"}\n\n:::\n\n::::\n\n## Data\n\n:::: {.columns}\n\n::: {.column width=\"45%\"}\n* source: [TidyTuesday](https://github.com/rfordatascience/tidytuesday/tree/master/data/2022/2022-07-05)\n* 2022-07-05\n* [Pennington, Kate](https://matrix.berkeley.edu/research-article/kate-pennington-on-gentrification-and-displacement-in-san-francisco/) (2018). *Bay Area Craigslist Rental Housing Posts, 2000-2018*. Retrieved from [this site](https://github.com/katepennington/historic_bay_area_craigslist_housing_posts/blob/master/clean_2000_2018.csv.zip).\n\n    * Craigslist listings\t\n:::\n\n::: {.column width=\"10%\"}\n\n:::\n\n::: {.column width=\"45%\"}\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-1_9f643bfedc6a777838c930675f3ec393'}\n\n```{.r .cell-code}\nlibrary(\"bayesrules\")\nlibrary(\"bayesplot\")\nlibrary(\"gt\")\nlibrary(\"patchwork\")\nlibrary(\"rstan\")\nlibrary(\"rstanarm\")\nlibrary(\"tidyverse\")\n\nknitr::opts_chunk$set(echo = TRUE)\n\nrent_raw <- rent_raw <- readr::read_csv(\"rent.csv\")\nrent_df <- rent_raw |>\n  filter(price >= 800 & price <= 5000) |>\n  filter(sqft >= 500 & sqft <= 2500) |>\n  filter(year >= 2009) |>\n  filter(county %in% c(\"alameda\", \"contra costa\"))\n\nrent_df$county <- factor(rent_df$county,\n                         levels = c(\"alameda\", \"contra costa\"))\n\nset.seed(320)\nrent_df_for_stan <- rent_df |>\n  slice_sample(prop = 0.05)\n```\n:::\n\n:::\n\n::::\n\n## Variables\n\n:::: {.columns}\n\n::: {.column width=\"40%\"}\n### Response Variable\n\n$Y$: price (monthly rent in USD)\n\n### Prediction\n\nWhat is the monthly rent for a property that is about 1500 square feet in size?\n:::\n\n::: {.column width=\"10%\"}\n\n:::\n\n::: {.column width=\"50%\"}\n### Predictor Variables\n\n* $X_{1}$: area (in square feet)\n* $X_{2}$: year (discrete, numerical)\n* $X_{3}$: county\n* $X_{4}$: number of bedrooms\n* $X_{5}$: number of bathrooms\n:::\n\n::::\n\n# Recap: Area\n\n::::: {.panel-tabset}\n\n## Model: Price versus Area\n\n$$Y = \\beta_{0} + \\beta_{1}X_{1}$$\n\n* $Y$: price (monthly rent in USD)\n* $X_{1}$: area (in square feet)\n\n## Viz\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-2_32711379e16ae7efecc291fb6f7171e7'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n## Stan\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-3_8348d18ff75fb5b225c7e8928224274f'}\n\n```{.r .cell-code}\nmod1 <- stan_glm(price ~ sqft,\n                 data = rent_df_for_stan,\n                 family = gaussian,\n                 chains = 4, iter = 5000*2, \n                 refresh = 0, seed = 320)\n```\n:::\n\n\n## Diagnostics\n\n::: {.callout-note collapse=\"true\"}\n## Function\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-4_333634089f243e9f10035542635b305d'}\n\n```{.r .cell-code}\nmodel_diagnostics <- function(the_stan_model){\n  p1 <- bayesplot::mcmc_trace(the_stan_model, size = 0.1) +\n  labs(title = \"MCMC Traces\")\n  print(p1)\n  \n  p2 <- bayesplot::mcmc_dens_overlay(the_stan_model) +\n  labs(title = \"Density Plots\")\n  print(p2)\n  \n  p3 <- bayesplot::mcmc_acf(the_stan_model) +\n  labs(title = \"Autocorrelations\")\n  print(p3)\n  \n  # effective sample size\n  print(\"Effective Sample Size:\")\n  print(bayesplot::neff_ratio(the_stan_model))\n  \n  # split-R metric\n  print(\"R-Hat\")\n  print(bayesplot::rhat(the_stan_model))\n}\n```\n:::\n\n\n:::\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-5_c28da0987599ea04c61b16245ff0ea93'}\n\n```{.r .cell-code}\nmodel_diagnostics(mod1)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n(Intercept)        sqft       sigma \n    0.92690     0.94080     0.90635 \n(Intercept)        sqft       sigma \n  1.0003567   1.0003625   0.9999335 \n```\n:::\n:::\n\n\n## PPC\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-6_99ca40a9ae86a4fc2c0d8873b98dcf4f'}\n\n```{.r .cell-code}\nbayesplot::pp_check(mod1, nreps = 50) +\n  labs(title = \"Posterior Predictive Check\",\n       subtitle = \"Model: price versus area\",\n       caption = \"SML 320\")\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-7_e791c9108aa7d55ed6325ae505bbc879'}\n\n```{.r .cell-code}\nbroom.mixed::tidy(mod1,\n                  effects = c(\"fixed\", \"aux\"),\n                  conf.int = TRUE, conf.level = 0.90) |>\n  mutate_if(is.numeric, round, digits = 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 5\n  term        estimate std.error conf.low conf.high\n  <chr>          <dbl>     <dbl>    <dbl>     <dbl>\n1 (Intercept) 1347.      73.8    1226.     1470.   \n2 sqft           0.631    0.0627    0.528     0.736\n3 sigma        617.      18.3     588.      649.   \n4 mean_PPD    2044.      36.8    1983.     2104.   \n```\n:::\n:::\n\n\nIn context, the intercept term somewhat implies that the fixed costs (e.g. taxes, insurance) are about $1350/month before the predictor variables.\n\n:::::\n\n\n# Recap: Year\n\n::::: {.panel-tabset}\n\n## Model: Price versus Year\n\n$$Y = \\beta_{0} + \\beta_{2}X_{2}$$\n\n* $Y$: price (monthly rent in USD)\n* $X_{2}$: year (discrete, numerical)\n\n## Viz\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-8_aa7508641a17baae2833007c07da7473'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Stan\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-9_936a1a13b53608fa2b2a0e60cb2cd981'}\n\n```{.r .cell-code}\nmod2 <- stan_glm(price ~ year,\n                 data = rent_df_for_stan,\n                 family = gaussian,\n                 chains = 4, iter = 5000*2, \n                 refresh = 0, seed = 320)\n```\n:::\n\n\n## Diagnostics\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-10_6a9d4089b1d26b1a65798bb76b96f153'}\n\n```{.r .cell-code}\nmodel_diagnostics(mod2)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Effective Sample Size:\"\n(Intercept)        year       sigma \n    0.94665     0.94665     0.92865 \n[1] \"R-Hat\"\n(Intercept)        year       sigma \n   1.000015    1.000015    1.000083 \n```\n:::\n:::\n\n\n## PPC\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-11_08e55968015ee16547a1c7d8c4ba0524'}\n\n```{.r .cell-code}\nbayesplot::pp_check(mod2, nreps = 50) +\n  labs(title = \"Posterior Predictive Check\",\n       subtitle = \"Model: price versus year\",\n       caption = \"SML 320\")\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-12_38f35c0a38f9b1b0048ccc93c686e1f3'}\n\n```{.r .cell-code}\nbroom.mixed::tidy(mod2,\n                  effects = c(\"fixed\", \"aux\"),\n                  conf.int = TRUE, conf.level = 0.90) |>\n  mutate_if(is.numeric, round, digits = 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 5\n  term        estimate std.error conf.low conf.high\n  <chr>          <dbl>     <dbl>    <dbl>     <dbl>\n1 (Intercept) -298002.   22595.  -335262.  -260276.\n2 year            149.      11.2     130.      168.\n3 sigma           586.      17.4     559.      616.\n4 mean_PPD       2044.      35.2    1987.     2102.\n```\n:::\n:::\n\n\nSince zero in not in the credible interval for $\\beta_{2}$, we have some evidence of a positive relationship between `year` and the monthly `price`.\n\n:::::\n\n\n# Categorical Variables\n\n## Indicator Variable\n\n:::: {.columns}\n\n::: {.column width=\"45%\"}\n$$X_{3} = \\begin{cases}\n  1, & \\text{Contra Costa County} \\\\ 0, & \\text{Alameda County}\n\\end{cases}$$\t\n:::\n\n::: {.column width=\"10%\"}\n\n:::\n\n::: {.column width=\"45%\"}\n![SF Bay Area counties](sf_counties.png)\n:::\n\n::::\n\n\n\n## Local Mean\n\n$$\\mu_{i} = \\beta_{0} + \\beta_{1}X_{3} \\quad\\text{with}\\quad X_{3} = \\begin{cases}\n  1, & \\text{Contra Costa County} \\\\ 0, & \\text{Alameda County}\n\\end{cases}$$\n\n* Alameda: $\\beta_{0} + \\beta_{1}(0) = \\beta_{0}$\n* Contra Costa: $\\beta_{0} + \\beta_{1}(1) = \\beta_{0} + \\beta_{1}$\n* standard deviation $\\sigma$ still represents variability at a given $X_{3}$ value.\n\n\n# County\n\n::::: {.panel-tabset}\n\n## Model: Price versus County\n\n$$Y = \\beta_{0} + \\beta_{3}X_{3}$$\n\n* $Y$: price (monthly rent in USD)\n* $X_{3}$: county\n\n## Viz\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-13_888dbb7e0a3a37a73dab77d9e64b8208'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n## Stan\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-14_5deda7d9a2519e7118fc94745d5cb376'}\n\n```{.r .cell-code}\nmod3 <- stan_glm(price ~ county,\n                 data = rent_df_for_stan,\n                 family = gaussian,\n                 chains = 4, iter = 5000*2, \n                 refresh = 0, seed = 320)\n```\n:::\n\n\n## Diagnostics\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-15_3c60e2c7b8cf8c5f846f87fe0ba01526'}\n\n```{.r .cell-code}\nmodel_diagnostics(mod3)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-15-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-15-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Effective Sample Size:\"\n       (Intercept) countycontra costa              sigma \n           0.98335            1.02215            0.97535 \n[1] \"R-Hat\"\n       (Intercept) countycontra costa              sigma \n         0.9999912          1.0001831          1.0001783 \n```\n:::\n:::\n\n\n## PPC\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-16_d6f5b8d31be2d8f79171b424c949f3f4'}\n\n```{.r .cell-code}\nbayesplot::pp_check(mod3, nreps = 50) +\n  labs(title = \"Posterior Predictive Check\",\n       subtitle = \"Model: price versus county\",\n       caption = \"SML 320\")\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-17_1297fa59fadd3604dece9ee0063d2f0c'}\n\n```{.r .cell-code}\nbroom.mixed::tidy(mod3,\n                  effects = c(\"fixed\", \"aux\"),\n                  conf.int = TRUE, conf.level = 0.90) |>\n  mutate_if(is.numeric, round, digits = 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 5\n  term               estimate std.error conf.low conf.high\n  <chr>                 <dbl>     <dbl>    <dbl>     <dbl>\n1 (Intercept)           2185.      35.4    2126.     2242.\n2 countycontra costa    -344.      54.8    -434.     -254.\n3 sigma                  647.      19.2     617.      680.\n4 mean_PPD              2044.      38.7    1980.     2108.\n```\n:::\n:::\n\n\nThis model placed properties in Alameda County as the baseline for analyses.  The coefficient on our categorical variable, $\\beta_{3}$, indicates that rents are about $350/month less in Contra Costa country (on average) by comparison.\n\n:::::\n\n\n# Multivariate Regression\n\n$$Y = \\beta_{0} + \\beta_{1}X_{1} + \\beta_{2}X_{2} + \\beta_{3}X_{3} + ...$$\n\n# Bed and Bath\n\n::::: {.panel-tabset}\n\n## Model\n\n$$Y = \\beta_{0} + \\beta_{1}X_{1} + \\beta_{4}X_{4} + \\beta_{5}X_{5}$$\n\n* $X_{1}$: area (in square feet)\n* $X_{4}$: number of bedrooms\n* $X_{5}$: number of bathrooms\n\n## Viz\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-18_bba63c5225d09938916d6dfad3a4dd5c'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-19_2d86dc87a09e90ec14994520ef8437a7'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n## Stan\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-20_7541c789a1b3406aab6b1b31edd8485a'}\n\n```{.r .cell-code}\nmod4 <- stan_glm(price ~ sqft + beds + baths,\n                 data = rent_df_for_stan,\n                 family = gaussian,\n                 chains = 4, iter = 5000*2, \n                 refresh = 0, seed = 320)\n```\n:::\n\n\n## Diagnostics\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-21_715b00ed17f87344b09d462fbfc93d54'}\n\n```{.r .cell-code}\nmodel_diagnostics(mod4)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-21-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-21-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Effective Sample Size:\"\n(Intercept)        sqft        beds       baths       sigma \n    1.14380     0.65705     0.71220     0.83715     0.89015 \n[1] \"R-Hat\"\n(Intercept)        sqft        beds       baths       sigma \n  0.9999506   1.0002182   1.0000545   1.0004859   0.9999406 \n```\n:::\n:::\n\n\n## PPC\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-22_aff074884dcc114574b29c40a76ebc60'}\n\n```{.r .cell-code}\nbayesplot::pp_check(mod4, nreps = 50) +\n  labs(title = \"Posterior Predictive Check\",\n       subtitle = \"Model: price versus beds and baths\",\n       caption = \"SML 320\")\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-23_3f4a484deb0be87201c86106445cc66d'}\n\n```{.r .cell-code}\nbroom.mixed::tidy(mod4,\n                  effects = c(\"fixed\", \"aux\"),\n                  conf.int = TRUE, conf.level = 0.90) |>\n  mutate_if(is.numeric, round, digits = 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 5\n  term        estimate std.error conf.low conf.high\n  <chr>          <dbl>     <dbl>    <dbl>     <dbl>\n1 (Intercept) 1549.      180.    1245.      1851.  \n2 sqft           0.671     0.254    0.254      1.08\n3 beds        -234.       89.7   -382.       -86.8 \n4 baths        233.      120.      38.1      431.  \n5 sigma        671.       40.8    609.       742.  \n6 mean_PPD    2196.       78.6   2066.      2324.  \n```\n:::\n:::\n\n\nCommentary: the negative coefficient (and credible interval values) for the number of `beds` predictor variable is quite curious. Does rent decrease as the number of beds increases?\n\n:::::\n\n\n# Interaction Terms\n\n::::: {.panel-tabset}\n\n## Slopes\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-24_b621738d6081611fa0da2e8b2a60abdb'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n## Code\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-25_5c8590f96f0026907aa213a79c9f4a5c'}\n\n```{.r .cell-code}\np1 <- rent_df |>\n  ggplot(aes(x = baths, y = price, color = county, group = county)) +\n  geom_point(alpha = 0.10) +\n  geom_smooth(method = \"lm\", formula = \"y~x\", \n              linewidth = 3, se =FALSE) +\n  labs(title = \"East Bay Rental Market\",\n       subtitle = \"Parallel Slopes\",\n       x = \"number of bathrooms\") +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n\np2 <- rent_df |>\n  ggplot(aes(x = beds, y = price, color = county, group = county)) +\n  geom_point(alpha = 0.10) +\n  geom_smooth(method = \"lm\", formula = \"y~x\", \n              linewidth = 3, se =FALSE) +\n  labs(title = \"East Bay Rental Market\",\n       subtitle = \"Possible Interaction\",\n       caption = \"Source: Tidy Tuesday\",\n       x = \"number of bedrooms\") +\n  theme_minimal() +\n  theme(legend.position = \"none\")\n\n# patchwork\np1 + p2\n```\n:::\n\n\n:::::\n\n\n# County Beds\n\n::::: {.panel-tabset}\n\n## Model\n\n$$Y = \\beta_{0} + \\beta_{3}X_{3} + \\beta_{5}X_{5} + \\beta_{6}X_{3}X_{5}$$\n\n* $X_{3}$: county\n* $X_{5}$: number of bathrooms\n\n\n\n## Stan\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-26_42d5e1048fe95dd6e8098f1aa3bbac9d'}\n\n```{.r .cell-code}\nmod5 <- stan_glm(price ~ county + beds + county:beds,\n                 data = rent_df_for_stan,\n                 family = gaussian,\n                 chains = 4, iter = 5000*2, \n                 refresh = 0, seed = 320)\n```\n:::\n\n\n## Diagnostics\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-27_74e3460289809d3093c709a0212454eb'}\n\n```{.r .cell-code}\nmodel_diagnostics(mod5)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-27-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-27-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Effective Sample Size:\"\n            (Intercept)      countycontra costa                    beds \n                0.49230                 0.41325                 0.47550 \ncountycontra costa:beds                   sigma \n                0.39545                 0.81385 \n[1] \"R-Hat\"\n            (Intercept)      countycontra costa                    beds \n              1.0001283               0.9999925               1.0001546 \ncountycontra costa:beds                   sigma \n              1.0000780               1.0003421 \n```\n:::\n:::\n\n\n## PPC\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-28_dcebcb840466658f5a8e518e873fc472'}\n\n```{.r .cell-code}\nbayesplot::pp_check(mod5, nreps = 50) +\n  labs(title = \"Posterior Predictive Check\",\n       subtitle = \"Model: interation between county and beds\",\n       caption = \"SML 320\")\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-29_4329c8845bbea326920ca86206198fcc'}\n\n```{.r .cell-code}\nbroom.mixed::tidy(mod5,\n                  effects = c(\"fixed\", \"aux\"),\n                  conf.int = TRUE, conf.level = 0.90) |>\n  mutate_if(is.numeric, round, digits = 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 5\n  term                    estimate std.error conf.low conf.high\n  <chr>                      <dbl>     <dbl>    <dbl>     <dbl>\n1 (Intercept)               1791.       84.4   1652.      1931.\n2 countycontra costa        -490.      133.    -711.      -270.\n3 beds                       193.       38.1    131.       256.\n4 countycontra costa:beds     41.5      55.7    -50.6      135.\n5 sigma                      619.       18.7    589.       651.\n6 mean_PPD                  2043.       37.6   1982.      2105.\n```\n:::\n:::\n\n\nSince zero is in the credible interval for the interaction term, it might be the case that the interaction between those two variables are not important.\n\n:::::\n\n# All Predictors\n\n::::: {.panel-tabset}\n\n## Model\n\n$$Y = \\beta_{0} + \\beta_{1}X_{1} + \\beta_{2}X_{2} + \\beta_{3}X_{3} + \\beta_{4}X_{4} + \\beta_{5}X_{5}$$\n\n* $X_{1}$: area (in square feet)\n* $X_{2}$: year (discrete, numerical)\n* $X_{3}$: county\n* $X_{4}$: number of bedrooms\n* $X_{5}$: number of bathrooms\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-30_324a9401c52133ae84905625c5afbd7a'}\n\n```{.r .cell-code}\nrent_df_for_all <- rent_df_for_stan |>\n  select(price, sqft, year, county, beds, baths)\n```\n:::\n\n\n\n## Stan\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-31_9da4b834a2c251fc81f657b3d3243858'}\n\n```{.r .cell-code}\nmod6 <- stan_glm(price ~ ., # price explained by all predictor vars\n                 data = rent_df_for_all,\n                 family = gaussian,\n                 chains = 4, iter = 5000*2, \n                 refresh = 0, seed = 320)\n```\n:::\n\n\n## Diagnostics\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-32_4517eeec11c33c3cf7a8247699b575a3'}\n\n```{.r .cell-code}\nmodel_diagnostics(mod6)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-32-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-32-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Effective Sample Size:\"\n       (Intercept)               sqft               year countycontra costa \n           1.24320            0.87375            1.24320            1.14510 \n              beds              baths              sigma \n           0.94375            1.10160            1.12780 \n[1] \"R-Hat\"\n       (Intercept)               sqft               year countycontra costa \n         0.9999691          0.9999978          0.9999689          0.9998384 \n              beds              baths              sigma \n         1.0000905          0.9998943          1.0002140 \n```\n:::\n:::\n\n\n## PPC\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-33_c9dbf43e76fd20f70fff2c1474f928e6'}\n\n```{.r .cell-code}\nbayesplot::pp_check(mod6, nreps = 50) +\n  labs(title = \"Posterior Predictive Check\",\n       subtitle = \"Model: all predictor variables\",\n       caption = \"SML 320\")\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-34_1dfc0f38c4e28502831b96a5cdd5961d'}\n\n```{.r .cell-code}\nbroom.mixed::tidy(mod6,\n                  effects = c(\"fixed\", \"aux\"),\n                  conf.int = TRUE, conf.level = 0.90) |>\n  mutate_if(is.numeric, round, digits = 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 8 × 5\n  term                  estimate std.error    conf.low   conf.high\n  <chr>                    <dbl>     <dbl>       <dbl>       <dbl>\n1 (Intercept)        -376298.    40575.    -442107.    -309907.   \n2 sqft                     0.582     0.184       0.276       0.886\n3 year                   188.       20.1       155.        220.   \n4 countycontra costa    -420.       85.5      -562.       -279.   \n5 beds                   -87.6      66.0      -199.         22.2  \n6 baths                  281.       87.9       140.        424.   \n7 sigma                  487.       29.8       443.        540.   \n8 mean_PPD              2196.       57.9      2100.       2291.   \n```\n:::\n:::\n\n\nAs these models become more complex, observe that the coefficients---and their interpretations---change.\n\n:::::\n\n\n# Model Selection\n\n::::: {.panel-tabset}\n\n## Cross Validation\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-35_9dc03e90aea1e214594afd3347e88421'}\n\n```{.r .cell-code}\nrent_df_for_ML <- rent_df |>\n  select(price, sqft, year, county, beds, baths)|>\n  filter(!is.na(sqft)) |>\n  filter(!is.na(beds)) |>\n  filter(!is.na(baths)) |>\n  slice_sample(prop = 0.05)\n\nmod1_cv <- bayesrules::prediction_summary_cv(\n  model = mod1, data = rent_df_for_ML, k = 10)\n\nmod2_cv <- bayesrules::prediction_summary_cv(\n  model = mod2, data = rent_df_for_ML, k = 10)\n\nmod3_cv <- bayesrules::prediction_summary_cv(\n  model = mod3, data = rent_df_for_ML, k = 10)\n\nmod4_cv <- bayesrules::prediction_summary_cv(\n  model = mod4, data = rent_df_for_ML, k = 10)\n\nmod5_cv <- bayesrules::prediction_summary_cv(\n  model = mod5, data = rent_df_for_ML, k = 10)\n\nmod6_cv <- bayesrules::prediction_summary_cv(\n  model = mod6, data = rent_df_for_ML, k = 10)\n```\n:::\n\n\n## Metrics\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-36_4b0c1d444a5ed981f62928689dc3516c'}\n::: {.cell-output-display}\n```{=html}\n<div id=\"muhcbsjzvv\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#muhcbsjzvv table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#muhcbsjzvv thead, #muhcbsjzvv tbody, #muhcbsjzvv tfoot, #muhcbsjzvv tr, #muhcbsjzvv td, #muhcbsjzvv th {\n  border-style: none;\n}\n\n#muhcbsjzvv p {\n  margin: 0;\n  padding: 0;\n}\n\n#muhcbsjzvv .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#muhcbsjzvv .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#muhcbsjzvv .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#muhcbsjzvv .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#muhcbsjzvv .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#muhcbsjzvv .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#muhcbsjzvv .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#muhcbsjzvv .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#muhcbsjzvv .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#muhcbsjzvv .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#muhcbsjzvv .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#muhcbsjzvv .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#muhcbsjzvv .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#muhcbsjzvv .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#muhcbsjzvv .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#muhcbsjzvv .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#muhcbsjzvv .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#muhcbsjzvv .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#muhcbsjzvv .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#muhcbsjzvv .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#muhcbsjzvv .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#muhcbsjzvv .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#muhcbsjzvv .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#muhcbsjzvv .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#muhcbsjzvv .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#muhcbsjzvv .gt_left {\n  text-align: left;\n}\n\n#muhcbsjzvv .gt_center {\n  text-align: center;\n}\n\n#muhcbsjzvv .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#muhcbsjzvv .gt_font_normal {\n  font-weight: normal;\n}\n\n#muhcbsjzvv .gt_font_bold {\n  font-weight: bold;\n}\n\n#muhcbsjzvv .gt_font_italic {\n  font-style: italic;\n}\n\n#muhcbsjzvv .gt_super {\n  font-size: 65%;\n}\n\n#muhcbsjzvv .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#muhcbsjzvv .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#muhcbsjzvv .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#muhcbsjzvv .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#muhcbsjzvv .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#muhcbsjzvv .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#muhcbsjzvv .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"5\" class=\"gt_heading gt_title gt_font_normal\" style><strong>ML on East Bay Rental Markets</strong></td>\n    </tr>\n    <tr class=\"gt_heading\">\n      <td colspan=\"5\" class=\"gt_heading gt_subtitle gt_font_normal gt_bottom_border\" style>Cross validation metrics</td>\n    </tr>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"model\">model</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mae\">mae</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mae_scaled\">mae_scaled</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"within_50\">within_50</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"within_95\">within_95</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"model\" class=\"gt_row gt_center\" style=\"background-color: #ADD8E6;\">1</td>\n<td headers=\"mae\" class=\"gt_row gt_center\">501.74</td>\n<td headers=\"mae_scaled\" class=\"gt_row gt_center\">0.76</td>\n<td headers=\"within_50\" class=\"gt_row gt_center\">0.46</td>\n<td headers=\"within_95\" class=\"gt_row gt_center\">0.97</td></tr>\n    <tr><td headers=\"model\" class=\"gt_row gt_center\" style=\"background-color: #ADD8E6;\">2</td>\n<td headers=\"mae\" class=\"gt_row gt_center\">448.55</td>\n<td headers=\"mae_scaled\" class=\"gt_row gt_center\">0.74</td>\n<td headers=\"within_50\" class=\"gt_row gt_center\">0.49</td>\n<td headers=\"within_95\" class=\"gt_row gt_center\">0.96</td></tr>\n    <tr><td headers=\"model\" class=\"gt_row gt_center\" style=\"background-color: #ADD8E6;\">3</td>\n<td headers=\"mae\" class=\"gt_row gt_center\">505.80</td>\n<td headers=\"mae_scaled\" class=\"gt_row gt_center\">0.74</td>\n<td headers=\"within_50\" class=\"gt_row gt_center\">0.47</td>\n<td headers=\"within_95\" class=\"gt_row gt_center\">0.97</td></tr>\n    <tr><td headers=\"model\" class=\"gt_row gt_center\" style=\"background-color: #ADD8E6;\">4</td>\n<td headers=\"mae\" class=\"gt_row gt_center\">503.26</td>\n<td headers=\"mae_scaled\" class=\"gt_row gt_center\">0.77</td>\n<td headers=\"within_50\" class=\"gt_row gt_center\">0.42</td>\n<td headers=\"within_95\" class=\"gt_row gt_center\">0.95</td></tr>\n    <tr><td headers=\"model\" class=\"gt_row gt_center\" style=\"background-color: #ADD8E6;\">5</td>\n<td headers=\"mae\" class=\"gt_row gt_center\">508.02</td>\n<td headers=\"mae_scaled\" class=\"gt_row gt_center\">0.78</td>\n<td headers=\"within_50\" class=\"gt_row gt_center\">0.44</td>\n<td headers=\"within_95\" class=\"gt_row gt_center\">0.96</td></tr>\n    <tr><td headers=\"model\" class=\"gt_row gt_center\" style=\"background-color: #ADD8E6; font-weight: bold;\">6</td>\n<td headers=\"mae\" class=\"gt_row gt_center\" style=\"background-color: #FFFF00; font-weight: bold;\">286.84</td>\n<td headers=\"mae_scaled\" class=\"gt_row gt_center\" style=\"background-color: #FFFF00; font-weight: bold;\">0.60</td>\n<td headers=\"within_50\" class=\"gt_row gt_center\" style=\"background-color: #FFFF00; font-weight: bold;\">0.55</td>\n<td headers=\"within_95\" class=\"gt_row gt_center\" style=\"background-color: #FFFF00; font-weight: bold;\">0.94</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n## Code\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-37_e2d5ba71fc9506412ed6e1107d1cc206'}\n\n```{.r .cell-code}\ndf_for_metrics <- rbind(mod1_cv$cv, mod2_cv$cv, mod3_cv$cv, \n                        mod4_cv$cv, mod5_cv$cv, mod6_cv$cv)\n\ndf_for_metrics |>\n  mutate(model = 1:6, .before = \"mae\") |>\n  gt() |>\n  cols_align(align = \"center\", columns = everything()) |>\n  fmt_number(columns = -model,\n             decimals = 2) |>\n  tab_header(\n    title = md(\"**ML on East Bay Rental Markets**\"),\n    subtitle = \"Cross validation metrics\"\n  ) |>\n  tab_style(\n    style = list(\n      cell_fill(color = \"yellow\"),\n      cell_text(weight = \"bold\")\n    ),\n    locations = cells_body(\n      columns = everything(),\n      rows = mae == min(mae)\n    )\n  ) |>\n  tab_style(\n    style = list(\n      cell_fill(color = \"lightblue\")\n    ),\n    locations = cells_body(\n      columns = model,\n      rows = everything()\n    )\n  )\n```\n:::\n\n\n:::::\n\n# Prediction\n\nSince the median absolute error (scaled or unscaled) was the lowest for `mod6` (out of the models that we looked at today), we will proceed with this choice as the best model.\n\n::::: {.panel-tabset}\n\n## Posterior Prediction Interval\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-38_c01b687981ce1f3917093b477d6f591c'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n\n## Code\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-39_4f7d40a2aca4e60a0cd03cb753ba85b4'}\n\n```{.r .cell-code}\nthese_predictions <- rstanarm::posterior_predict(\n  mod6, newdata = data.frame(sqft = 1500,\n                             year = 2016,\n                             county = \"contra costa\",\n                             beds = 3,\n                             baths = 1.5))\ncredible_interval <- round(quantile(these_predictions, c(0.05, 0.95)))\nsubtitle_string <- paste0(\"90 Percent Credible Interval: (\",\n                          credible_interval[1], \", \",\n                          credible_interval[2], \")\")\nbayesplot::mcmc_areas(these_predictions) +\n  labs(title = \"Predictions for 1500 sqft, 3 beds, 1.5 baths in Contra Costa county (2016)\",\n       subtitle = subtitle_string,\n       caption = \"SML 320\",\n       x = \"monthly rent (USD)\")\n```\n:::\n\n\n:::::\n\n\n# Time Series\n\n## SF Rental Market\n\n::::: {.panel-tabset}\n\n## Data\n\n* average rent by day\n* one average price per day\n* $n = 399$ data points\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-40_6d049d6f31f1a3cb4e1fe7cc3b41083c'}\n\n```{.r .cell-code}\nrent_df <- rent_raw |>\n  filter(price >= 800 & price <= 5000) |>\n  filter(sqft >= 500 & sqft <= 2500) |>\n  filter(year >= 2009)\n\nrent_ts <- rent_df |>\n  select(year, date, price) |>\n  group_by(date) |>\n  mutate(avg_price = mean(price, na.rm = TRUE)) |>\n  ungroup() |>\n  select(year, date, avg_price) |>\n  distinct() |>\n  arrange(date)\n\n# convert string to YYYY/MM/DD date format\nrent_ts$date <- lubridate::ymd(rent_ts$date) \n```\n:::\n\n\n## Plot\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-41_2c1547d760610cbadf818d4af8bc9eef'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-41-1.png){width=672}\n:::\n:::\n\n\n## Code\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-42_2e32a0adc90912ddc36d062ad95439c1'}\n\n```{.r .cell-code}\nrent_ts |>\n  ggplot(aes(x = date, y = avg_price)) +\n  geom_line() +\n  labs(title = \"SF Bay Area Rental Market\",\n       subtitle = \"2009 to 2018\",\n       caption = \"SML 320\",\n       x = \"date\", y = \"average monthly rent (USD)\") +\n  theme_minimal()\n```\n:::\n\n\n:::::\n\n## Causal Impact\n\n* training over *pre-intervention period*\n* testing over *post-intervention period*\n* the `CausalImpact` function\n\n    * assembles structural time-series model\n    * performs posterior inference\n    * computes estimates for casual effect\n\n## Claim 1: Change in Market in 2016\n\n::::: {.panel-tabset}\n\n## Viz\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-43_eba8cb2d1035a870e237b4ff0e5302f5'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-43-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-44_932e0899c3821037ba7e5c49774a19d8'}\n\n```{.r .cell-code}\nrent_ts |>\n  ggplot(aes(x = date, y = avg_price)) +\n  geom_line() +\n  geom_vline(xintercept = lubridate::ymd(\"20160101\"),\n             color = \"red\", linetype = 2, linewidth = 3) +\n  labs(title = \"Was there a market intervention in 2016?\",\n       caption = \"SML 320\",\n       x = \"date\", y = \"average monthly rent (USD)\") +\n  theme_minimal()\n```\n:::\n\n\n## R Code\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-45_37c4ff49c380d4167d542764959ca75d'}\n\n```{.r .cell-code}\nintervention_index <- which.max(rent_ts$year >= 2016)\npre_intervention <- c(1, intervention_index-1)\npost_intervention <- c(intervention_index, nrow(rent_ts))\n\nts_impact <- CausalImpact::CausalImpact(rent_ts$avg_price,\n                                        pre_intervention,\n                                        post_intervention)\n```\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-46_b877e5875bded9e8d2d7a9f31e000d0b'}\n\n```{.r .cell-code}\nsummary(ts_impact)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPosterior inference {CausalImpact}\n\n                         Average         Cumulative      \nActual                   2821            335689          \nPrediction (s.d.)        2819 (104)      335481 (12414)  \n95% CI                   [2625, 3031]    [312434, 360678]\n                                                         \nAbsolute effect (s.d.)   1.7 (104)       207.6 (12414)   \n95% CI                   [-210, 195]     [-24989, 23255] \n                                                         \nRelative effect (s.d.)   0.2% (3.7%)     0.2% (3.7%)     \n95% CI                   [-6.9%, 7.4%]   [-6.9%, 7.4%]   \n\nPosterior tail-area probability p:   0.48075\nPosterior prob. of a causal effect:  52%\n\nFor more details, type: summary(impact, \"report\")\n```\n:::\n:::\n\n\n## Viz\n\nThe `plot` of an \"impact\" object returns a `ggplot` object!\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-47_bb923864e63d033e36350122163ec8d9'}\n\n```{.r .cell-code}\nplot(ts_impact)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-47-1.png){width=672}\n:::\n:::\n\n\n## Inference\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-48_e4b453442b45badb4cf212066e41d29e'}\n\n```{.r .cell-code}\nsummary(ts_impact, \"report\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis report {CausalImpact}\n\n\nDuring the post-intervention period, the response variable had an average value of approx. 2.82K. In the absence of an intervention, we would have expected an average response of 2.82K. The 95% interval of this counterfactual prediction is [2.63K, 3.03K]. Subtracting this prediction from the observed response yields an estimate of the causal effect the intervention had on the response variable. This effect is 0.00K with a 95% interval of [-0.21K, 0.20K]. For a discussion of the significance of this effect, see below.\n\nSumming up the individual data points during the post-intervention period (which can only sometimes be meaningfully interpreted), the response variable had an overall value of 335.69K. Had the intervention not taken place, we would have expected a sum of 335.48K. The 95% interval of this prediction is [312.43K, 360.68K].\n\nThe above results are given in terms of absolute numbers. In relative terms, the response variable showed an increase of +0%. The 95% interval of this percentage is [-7%, +7%].\n\nThis means that, although the intervention appears to have caused a positive effect, this effect is not statistically significant when considering the entire post-intervention period as a whole. Individual days or shorter stretches within the intervention period may of course still have had a significant effect, as indicated whenever the lower limit of the impact time series (lower plot) was above zero. The apparent effect could be the result of random fluctuations that are unrelated to the intervention. This is often the case when the intervention period is very long and includes much of the time when the effect has already worn off. It can also be the case when the intervention period is too short to distinguish the signal from the noise. Finally, failing to find a significant effect can happen when there are not enough control variables or when these variables do not correlate well with the response variable during the learning period.\n\nThe probability of obtaining this effect by chance is p = 0.481. This means the effect may be spurious and would generally not be considered statistically significant. \n```\n:::\n:::\n\n\n:::::\n\n\n## Claim 2: Change in Market in 2014\n\n::::: {.panel-tabset}\n\n## Viz\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-49_ee86694ed4aa3f553b560cb7e2cbde81'}\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-49-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-50_b4fcc6740cdb2f71eadf77e02e72b93b'}\n\n```{.r .cell-code}\nrent_ts |>\n  ggplot(aes(x = date, y = avg_price)) +\n  geom_line() +\n  geom_vline(xintercept = lubridate::ymd(\"20140101\"),\n             color = \"red\", linetype = 2, linewidth = 3) +\n  labs(title = \"Was there a market intervention in 2014?\",\n       caption = \"SML 320\",\n       x = \"date\", y = \"average monthly rent (USD)\") +\n  theme_minimal()\n```\n:::\n\n\n## R Code\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-51_d91a242b4ab49d5c99fb69652182d09b'}\n\n```{.r .cell-code}\nintervention_index <- which.max(rent_ts$year >= 2014)\npre_intervention <- c(1, intervention_index-1)\npost_intervention <- c(intervention_index, nrow(rent_ts))\n\nts_impact <- CausalImpact::CausalImpact(rent_ts$avg_price,\n                                        pre_intervention,\n                                        post_intervention)\n```\n:::\n\n\n## Model Stats\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-52_f4252541686848432dbb8ad257d5f3af'}\n\n```{.r .cell-code}\nsummary(ts_impact)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPosterior inference {CausalImpact}\n\n                         Average        Cumulative      \nActual                   2788           521273          \nPrediction (s.d.)        2301 (80)      430286 (14984)  \n95% CI                   [2156, 2469]   [403170, 461701]\n                                                        \nAbsolute effect (s.d.)   487 (80)       90987 (14984)   \n95% CI                   [319, 632]     [59572, 118103] \n                                                        \nRelative effect (s.d.)   21% (4.2%)     21% (4.2%)      \n95% CI                   [13%, 29%]     [13%, 29%]      \n\nPosterior tail-area probability p:   0.0012\nPosterior prob. of a causal effect:  99.88024%\n\nFor more details, type: summary(impact, \"report\")\n```\n:::\n:::\n\n\n## Viz\n\nThe `plot` of an \"impact\" object returns a `ggplot` object!\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-53_49c5cc6bca0ee125cf833efb3a59ff89'}\n\n```{.r .cell-code}\nplot(ts_impact)\n```\n\n::: {.cell-output-display}\n![](13_extending_regression_files/figure-html/unnamed-chunk-53-1.png){width=672}\n:::\n:::\n\n\n## Inference\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-54_ee75954a7acfca4e149a1fe2e2e0433f'}\n\n```{.r .cell-code}\nsummary(ts_impact, \"report\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis report {CausalImpact}\n\n\nDuring the post-intervention period, the response variable had an average value of approx. 2.79K. By contrast, in the absence of an intervention, we would have expected an average response of 2.30K. The 95% interval of this counterfactual prediction is [2.16K, 2.47K]. Subtracting this prediction from the observed response yields an estimate of the causal effect the intervention had on the response variable. This effect is 0.49K with a 95% interval of [0.32K, 0.63K]. For a discussion of the significance of this effect, see below.\n\nSumming up the individual data points during the post-intervention period (which can only sometimes be meaningfully interpreted), the response variable had an overall value of 521.27K. By contrast, had the intervention not taken place, we would have expected a sum of 430.29K. The 95% interval of this prediction is [403.17K, 461.70K].\n\nThe above results are given in terms of absolute numbers. In relative terms, the response variable showed an increase of +21%. The 95% interval of this percentage is [+13%, +29%].\n\nThis means that the positive effect observed during the intervention period is statistically significant and unlikely to be due to random fluctuations. It should be noted, however, that the question of whether this increase also bears substantive significance can only be answered by comparing the absolute effect (0.49K) to the original goal of the underlying intervention.\n\nThe probability of obtaining this effect by chance is very small (Bayesian one-sided tail-area probability p = 0.001). This means the causal effect can be considered statistically significant. \n```\n:::\n:::\n\n\n:::::\n\n\n# Footnotes\n\n* [CausalImpact vignette](https://cran.r-project.org/web/packages/CausalImpact/vignettes/CausalImpact.html)\n\n::: {.callout-note collapse=\"true\"}\n## Session Info\n\n\n::: {.cell hash='13_extending_regression_cache/html/unnamed-chunk-55_d6588a5bff046e40f8f34023863bb32a'}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31 ucrt)\nPlatform: x86_64-w64-mingw32/x64 (64-bit)\nRunning under: Windows 10 x64 (build 19045)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/New_York\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] gt_0.9.0           patchwork_1.1.2    lubridate_1.9.3    forcats_1.0.0     \n [5] stringr_1.5.1      dplyr_1.1.4        purrr_1.0.2        readr_2.1.5       \n [9] tidyr_1.3.1        tibble_3.2.1       ggplot2_3.4.3      tidyverse_2.0.0   \n[13] rstanarm_2.21.4    Rcpp_1.0.11        rstan_2.32.5       StanHeaders_2.32.5\n[17] ggtext_0.1.2       bayesplot_1.10.0   bayesrules_0.0.2  \n\nloaded via a namespace (and not attached):\n  [1] BoomSpikeSlab_1.2.6 gridExtra_2.3       inline_0.3.19      \n  [4] rlang_1.1.1         magrittr_2.0.3      snakecase_0.11.0   \n  [7] matrixStats_1.0.0   e1071_1.7-13        compiler_4.3.2     \n [10] loo_2.6.0           callr_3.7.3         vctrs_0.6.5        \n [13] reshape2_1.4.4      pkgconfig_2.0.3     crayon_1.5.2       \n [16] fastmap_1.1.1       ellipsis_0.3.2      labeling_0.4.3     \n [19] utf8_1.2.4          threejs_0.3.3       promises_1.2.1     \n [22] rmarkdown_2.24      tzdb_0.4.0          markdown_1.8       \n [25] ps_1.7.5            nloptr_2.0.3        xfun_0.40          \n [28] jsonlite_1.8.7      later_1.3.1         bsts_0.9.10        \n [31] parallel_4.3.2      prettyunits_1.2.0   R6_2.5.1           \n [34] dygraphs_1.1.1.6    stringi_1.8.3       boot_1.3-28.1      \n [37] assertthat_0.2.1    knitr_1.43          CausalImpact_1.3.0 \n [40] zoo_1.8-12          base64enc_0.1-3     httpuv_1.6.11      \n [43] Matrix_1.6-1.1      splines_4.3.2       igraph_1.4.3       \n [46] timechange_0.3.0    tidyselect_1.2.0    rstudioapi_0.15.0  \n [49] yaml_2.3.8          codetools_0.2-19    miniUI_0.1.1.1     \n [52] curl_5.0.2          processx_3.8.1      Boom_0.9.15        \n [55] pkgbuild_1.4.0      lattice_0.21-9      plyr_1.8.8         \n [58] withr_3.0.0         shiny_1.7.5         groupdata2_2.0.2   \n [61] evaluate_0.21       survival_3.5-7      proxy_0.4-27       \n [64] RcppParallel_5.1.7  xml2_1.3.6          xts_0.13.1         \n [67] pillar_1.9.0        DT_0.28             stats4_4.3.2       \n [70] shinyjs_2.1.0       generics_0.1.3      hms_1.1.3          \n [73] rstantools_2.3.1    munsell_0.5.0       scales_1.2.1       \n [76] minqa_1.2.5         gtools_3.9.4        xtable_1.8-4       \n [79] class_7.3-22        glue_1.6.2          janitor_2.2.0      \n [82] tools_4.3.2         shinystan_2.6.0     lme4_1.1-33        \n [85] colourpicker_1.2.0  grid_4.3.2          QuickJSR_1.1.3     \n [88] crosstalk_1.2.0     colorspace_2.1-0    nlme_3.1-163       \n [91] cli_3.6.1           fansi_1.0.6         V8_4.3.0           \n [94] gtable_0.3.4        digest_0.6.33       farver_2.1.1       \n [97] htmlwidgets_1.6.2   htmltools_0.5.6     lifecycle_1.0.4    \n[100] mime_0.12           gridtext_0.1.5      shinythemes_1.2.0  \n[103] MASS_7.3-60        \n```\n:::\n:::\n\n:::\n\n\n:::: {.columns}\n\n::: {.column width=\"45%\"}\n\t\n:::\n\n::: {.column width=\"10%\"}\n\n:::\n\n::: {.column width=\"45%\"}\n\n:::\n\n::::\n\n\n\n::::: {.panel-tabset}\n\n\n\n:::::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}